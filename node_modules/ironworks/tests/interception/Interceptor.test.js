
var _ = require('lodash');

var chai = require('chai')
    ,expect = chai.expect;

chai.use(require('../_chai/toHaveAListener'));
chai.use(require('../_chai/toHaveAMethod'));

var ports = require('../test-ports.json');

var Interceptor = require('../../src/interception/Interceptor');
var Service = require('../../src/service/Service');
var Worker = require('../../src/workers/Worker');
var HttpWorker = require('../../src/workers/HttpWorker');
var SocketWorker = require('../../src/workers/SocketWorker');
var CfClientWorker = require('../../src/workers/CfClientWorker');

describe('Interceptor', function () {
    var service;

    beforeEach(function (done) {
        if (_.isUndefined(process.env['VCAP_SERVICES'])) {
            process.env['VCAP_SERVICES'] = JSON.stringify(
                {
                    "user-provided": [
                        {
                            "credentials": {
                                "iw": "true",
                                "serviceName": "my-other-service",
                                "protocol":"http",
                                "host": "localhost",
                                "port": ports.CfClientWorker[0],
                                "route":"",
                                "token": "qwer32r123rewr213r"
                            },
                            "label": "user-provided",
                            "name": "my-other-service",
                            "syslog_drain_url": "",
                            "tags": []
                        },
                        {
                            "credentials": {
                                "iw": "true",
                                "serviceName": "service-name",
                                "protocol":"http",
                                "host": "localhost",
                                "port": ports.Interceptor[0],
                                "route":"",
                                "token": "qwer32r123rewr213r"
                            },
                            "label": "user-provided",
                            "name": "service-name",
                            "syslog_drain_url": "",
                            "tags": []
                        }
                    ]
                });
        }
        done();
    });

    it("should intercept an event that has been intercepted via 'comm.intercept' and be able to pass through it's emitted data", function (done) {
        var service = new Service('service-name', {
            dependencyCheckTimeout: 250,
            dependencyCheckFrequency: 10
        })
            .inject(function (service, use) {
                var w = new Worker([
                    'iw-socket'
                ], service.comm, service.who(), {
                    id: 'worker-test-id',
                    name: 'worker-test'
                });
                w.respond('test', function (req, cb) {
                    cb(null, req);
                });
                w.init = function (cb) {
                    if (!_.isUndefined(cb)) {
                        cb();
                    }
                };
                w.start = function (deps, cb) {
                    if (!_.isUndefined(cb)) {
                        cb();
                    }
                };
                use(w);
            })
            .inject(function (service, use) {
                use(new CfClientWorker(service.comm, service.who(), {}));
            })
            .inject(function (service, use) {
                use(new SocketWorker(service.comm, service.who()));
            })
            .inject(function (service, use) {
                use(new HttpWorker(service.comm, service.who(), {
                    port: ports.Interceptor[0]
                }));
            })
            .info('error', function (e) {
                throw e;
            })
            .info('ready', function (iw) {
                var test = {
                    some: 'data'
                };
                var intercepted = 0;
                iw.service.comm.intercept('comm.service-name.request.worker-test.test').respond(
                    function (meta, req, cb, next, emit, stop) {
                        intercepted++;
                        next(req, cb);
                    });
                iw.service.comm.request('request.worker-test.test', test, function (e, res) {
                    expect(intercepted).to.be.equal(1);
                    expect(res).to.be.equal(test);
                    iw.service.dispose(function () {
                        done();
                    });
                });
            })
            .start();
    });

    it("should intercept an event that has been intercepted via 'comm.intercept' and be able stop the event chain", function (done) {
        var service = new Service('service-name', {
            dependencyCheckTimeout: 250,
            dependencyCheckFrequency: 10
        })
            .inject(function (service, use) {
                var w = new Worker([
                    'iw-socket'
                ], service.comm, service.who(), {
                    id: 'worker-test-id',
                    name: 'worker-test'
                });
                w.respond('test', function (req, cb) {
                    cb(null, req);
                });
                w.init = function (cb) {
                    if (!_.isUndefined(cb)) {
                        cb();
                    }
                };
                w.start = function (deps, cb) {
                    if (!_.isUndefined(cb)) {
                        cb();
                    }
                };
                use(w);
            })
            .inject(function (service, use) {
                use(new CfClientWorker(service.comm, service.who(), {}));
            })
            .inject(function (service, use) {
                use(new SocketWorker(service.comm, service.who()));
            })
            .inject(function (service, use) {
                use(new HttpWorker(service.comm, service.who(), {
                    port: ports.Interceptor[0]
                }));
            })
            .info('error', function (e) {
                throw e;
            })
            .info('ready', function (iw) {
                iw.service.comm.intercept('comm.service-name.request.worker-test.test').respond(
                    function (meta, req, cb, next, stop) {
                        stop();
                        done();
                    });
                iw.service.comm.request('request.worker-test.test', {
                    some: 'data'
                }, function (e, res) {
                    done();
                });
            })
            .start();
    });

    it("should intercept an event that has been intercepted via 'comm.intercept' and be able intercept a listener callback before it's sent to the emitter", function (done) {
        var service = new Service('service-name', {
            dependencyCheckTimeout: 250,
            dependencyCheckFrequency: 10
        })
            .inject(function (service, use) {
                var w = new Worker([
                    'iw-socket'
                ], service.comm, service.who(), {
                    id: 'worker-test-id',
                    name: 'worker-test'
                });
                w.respond('test', function (req, cb) {
                    cb(null, req);
                });
                w.init = function (cb) {
                    if (!_.isUndefined(cb)) {
                        cb();
                    }
                };
                w.start = function (deps, cb) {
                    if (!_.isUndefined(cb)) {
                        cb();
                    }
                };
                use(w);
            })
            .inject(function (service, use) {
                use(new CfClientWorker(service.comm, service.who(), {}));
            })
            .inject(function (service, use) {
                use(new SocketWorker(service.comm, service.who()));
            })
            .inject(function (service, use) {
                use(new HttpWorker(service.comm, service.who(), {
                    port: ports.Interceptor[0]
                }));
            })
            .info('error', function (e) {
                throw e;
            })
            .info('ready', function (iw) {
                var test = {
                    some: 'data'
                };
                var intercepted = {
                    some: 'intercepted ;)'
                };
                iw.service.comm.intercept('comm.service-name.request.worker-test.test').respond(
                    function (meta, req, cb, next, stop) {
                        expect(req).to.be.equal(test);
                        next(req, function(e, res) {
                            cb(null, intercepted);
                        });
                    });
                iw.service.comm.request('request.worker-test.test', test, function (e, res) {
                    expect(res).to.be.equal(intercepted);
                    iw.service.dispose(function () {
                        done();
                    });
                });
            })
            .start();
    });
});
